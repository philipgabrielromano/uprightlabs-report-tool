<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upright Labs Paid Order Tool</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    details > summary { font-weight: bold; cursor: pointer; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Upright Labs Report</h1>

  <label>Start Date: <input type="date" id="start"></label>
  <label>End Date: <input type="date" id="end"></label>
  <label>Shipping Method:
    <select id="shippingMethod">
      <option value="">-- Any --</option>
    </select>
  </label>
  <button onclick="loadReport()">Run Report</button>
  <button onclick="downloadCSV()">Export CSV</button>

  <div id="results"></div>

  <script defer>
  window.addEventListener("DOMContentLoaded", () => {
    async function loadReport() {
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;
      const method = document.getElementById('shippingMethod').value;

      const res = await fetch(`/api/export?time_start=${start}T00:00:00.000Z&time_end=${end}T23:59:59.999Z&shipping_method=${encodeURIComponent(method)}`);
      const data = await res.json();

      renderTable(data);
      populateShippingMethods(data);
      window.__reportData = data;
    }

    function renderTable(data) {
      data.sort((a, b) => new Date(b.order_paid_at) - new Date(a.order_paid_at));
      let html = '<table><thead><tr><th>SKU</th><th>Shipping Method</th><th>Inventory Location</th><th>Product Title</th><th>Buyer ID</th><th>Shipping Contact</th><th>Shipping City</th><th>Order Paid At</th></tr></thead><tbody>';
      for (const row of data) {
        const orderItems = JSON.parse(row.order_items_json || '[]');
        const firstItem = orderItems[0] || {};
        html += `<tr>
          <td>${row.product_sku}</td>
          <td>${row.shipping_method || '—'}</td>
          <td>${row.inventory_location || '—'}</td>
          <td>${row.product_title || '—'}</td>
          <td>${row.channel_buyer_id || '—'}</td>
          <td>${row.shipping_contact || '—'}</td>
          <td>${row.shipping_city || '—'}</td>
          <td>${row.order_paid_at || '—'}</td>
        </tr>`;
      }
      html += '</tbody></table>';
      document.getElementById('results').innerHTML = html;
    }

    function populateShippingMethods(data) {
      const select = document.getElementById('shippingMethod');
      const current = select.value;
      const staticOptions = ['FedEx', 'Pickup', 'FedExHomeDelivery'];
      const set = new Set(staticOptions);
      data.forEach(row => {
        const items = JSON.parse(row.order_items_json || '[]');
        items.forEach(item => {
          if (item.shipping_method) set.add(item.shipping_method);
        });
      });
      select.innerHTML = '<option value="">-- Any --</option>';
      [...set].sort().forEach(m => {
        select.innerHTML += `<option value="${m}" ${m === current ? 'selected' : ''}>${m}</option>`;
      });
    }

    function downloadCSV() {
  const data = window.__reportData || [];
  const keys = Object.keys(data[0] || {});
  const rows = [keys.join(',')];
  data.forEach(obj => {
    rows.push(keys.map(k => JSON.stringify(obj[k] || '')).join(','));
  });
  const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'upright_report.csv';
  a.click();
  URL.revokeObjectURL(url);
}

    window.loadReport = loadReport;
    window.downloadCSV = downloadCSV;
  });
</script>
</body>
</html>
